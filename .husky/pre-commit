#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."
echo ""

# Run linting
echo "ğŸ“ Running ESLint..."
npm run lint
LINT_EXIT_CODE=$?

if [ $LINT_EXIT_CODE -ne 0 ]; then
  echo "âŒ Linting failed! Please fix the errors above."
  exit 1
fi

echo "âœ… Linting passed"
echo ""

# Run tests
echo "ğŸ§ª Running tests..."
npm run test:run
TEST_EXIT_CODE=$?

if [ $TEST_EXIT_CODE -ne 0 ]; then
  echo ""
  echo "âŒ Tests failed! Commit blocked."
  echo "ğŸ“Š Check test-reports/test-report.html for detailed results"
  echo "ğŸ“¸ Screenshots available in test-reports/screenshots/"
  echo "ğŸ“Š Traces available in test-reports/traces/"
  exit 1
fi

echo ""
echo "âœ… All tests passed"
echo ""

# Check for breaking changes
echo "ğŸ” Checking for breaking changes..."

# Parse test results to check if breaking change tests passed
if grep -q "Breaking Change Detection" test-reports/test-report.json 2>/dev/null; then
  if grep -q '"pass":.*Breaking Change Detection' test-reports/test-report.json; then
    echo "âœ… No breaking changes detected"
  else
    echo "âŒ Breaking changes detected in API! Commit blocked."
    echo "   Review the failing tests in test-reports/test-report.html"
    exit 1
  fi
else
  echo "âš ï¸  Could not verify breaking changes (test report not found)"
fi

echo ""
echo "âœ… All pre-commit checks passed!"
echo "ğŸ“Š Test report: test-reports/test-report.html"
echo ""
